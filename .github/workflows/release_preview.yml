# Preview Release Workflow (@preview-*)
#
# This workflow creates preview releases for testing features before they are merged to main.
# It must be triggered manually via GitHub Actions UI.
#
# How to trigger:
# 1. Navigate to Actions > Release Preview in GitHub
# 2. Click "Run workflow" and select:
#    - Branch: The branch you want to create a preview release from (typically an active PR branch)
#    - Publish target: npm-only or npm-and-ghcr (NPM packages + Docker images)
#    - Custom suffix (optional): Custom tag suffix instead of branch name
#
# What it does:
# 1. Validates the branch (cannot run on main)
# 2. Generates a sanitized tag from the branch name or custom suffix (e.g., @preview-feat-add-api-route)
# 3. Versions packages using changesets in snapshot mode
# 4. Publishes NPM packages with @preview-* dist-tag
# 5. Optionally builds and publishes Docker images with preview-* tag
# 6. Posts/updates a comment on the associated PR with installation instructions
#
# Published artifacts:
# - NPM packages: Published with @preview-{branch-name} or @preview-{custom-suffix} tag
# - Docker images (optional): Published with preview-{branch-name} or preview-{custom-suffix} tag
# - No GitHub releases or tags are created
#
# Use cases:
# - Testing features before merging to main
# - Collaborating on development work
# - Validating fixes for specific issues
# - QA testing of work-in-progress features
#
# Important notes:
# - Preview releases are NOT stable and should not be used in production
# - They are ephemeral and don't modify the repository (no commits/tags)
# - Only authorized NameHash team members can trigger preview releases
# - Preview releases are built from active development branches
# - Installation: npm install @ensnode/package-name@preview-branch-name
# - Cleanup: Use npm dist-tag rm to manually remove preview tags when no longer needed
#
# Documentation: https://ensnode.io/docs/contributing/releases#preview-release

name: Release Preview (@preview)

on:
  workflow_dispatch:
    inputs:
      custom_suffix:
        description: 'Optional custom suffix to append to the tag assigned to all assets published in the release preview. If not defined, defaults to the name of the branch associated with the release preview.'
        type: string
        required: false
      publish_target:
        description: 'Where should the release preview be published?'
        type: choice
        required: true
        default: 'npm-and-ghcr'
        options:
          - npm-only
          - npm-and-ghcr

concurrency:
  group: prerelease-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  validate-and-prepare:
    name: Validate Branch & Prepare
    runs-on: blacksmith-4vcpu-ubuntu-2204
    if: github.repository == 'namehash/ensnode'
    outputs:
      branch-suffix: ${{ steps.prepare.outputs.branch-suffix }}
      dist-tag: ${{ steps.prepare.outputs.dist-tag }}
      snapshot-tag: ${{ steps.prepare.outputs.snapshot-tag }}
      docker-tag-base: ${{ steps.prepare.outputs.docker-tag-base }}
      commit-sha: ${{ steps.prepare.outputs.commit-sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate branch
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "‚ùå Cannot run prerelease workflow on main branch"
            echo "Use the snapshot workflow instead for main branch previews"
            exit 1
          fi
          echo "‚úÖ Branch validation passed: ${{ github.ref_name }}"

      - name: Prepare tags and identifiers
        id: prepare
        run: |
          # Get short commit SHA
          COMMIT_SHA=$(git rev-parse --short HEAD)

          # Sanitize branch name for use in versions and tags
          if [[ -n "${{ inputs.custom_suffix }}" ]]; then
            BRANCH_SUFFIX="${{ inputs.custom_suffix }}"
          else
            BRANCH_SUFFIX="${{ github.ref_name }}"
          fi
          # Replace / with -
          BRANCH_SUFFIX="${BRANCH_SUFFIX//\//-}"
          # Replace special characters with -
          BRANCH_SUFFIX="${BRANCH_SUFFIX//[^a-zA-Z0-9-]/-}"
          # Convert to lowercase
          BRANCH_SUFFIX=$(echo "$BRANCH_SUFFIX" | tr '[:upper:]' '[:lower:]')
          # Remove consecutive dashes (repeat until no more changes)
          while [[ "$BRANCH_SUFFIX" =~ --+ ]]; do
            BRANCH_SUFFIX="${BRANCH_SUFFIX//--/-}"
          done
          # Truncate to 30 characters
          BRANCH_SUFFIX="${BRANCH_SUFFIX:0:30}"
          # Remove trailing dashes
          BRANCH_SUFFIX="${BRANCH_SUFFIX%-}"
          # Remove leading dashes
          BRANCH_SUFFIX="${BRANCH_SUFFIX#-}"

          # Create dist-tag (NPM doesn't allow dots in tags)
          DIST_TAG="preview-${BRANCH_SUFFIX}"

          # Snapshot tag for changesets (used in version string)
          SNAPSHOT_TAG="preview-${BRANCH_SUFFIX}"

          # Docker tag base (no version, just branch)
          DOCKER_TAG_BASE="preview-${BRANCH_SUFFIX}"

          echo "branch-suffix=${BRANCH_SUFFIX}" >> $GITHUB_OUTPUT
          echo "dist-tag=${DIST_TAG}" >> $GITHUB_OUTPUT
          echo "snapshot-tag=${SNAPSHOT_TAG}" >> $GITHUB_OUTPUT
          echo "docker-tag-base=${DOCKER_TAG_BASE}" >> $GITHUB_OUTPUT
          echo "commit-sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT

          echo "üè∑Ô∏è NPM dist-tag: ${DIST_TAG}"
          echo "üì∏ Snapshot tag: ${SNAPSHOT_TAG}"
          echo "üê≥ Docker tag base: ${DOCKER_TAG_BASE}"
          echo "üìù Commit SHA: ${COMMIT_SHA}"

  build-and-publish-npm:
    name: Build & Publish Release Preview Packages to NPM
    runs-on: blacksmith-4vcpu-ubuntu-2204
    needs: validate-and-prepare
    if: inputs.publish_target == 'npm-only' || inputs.publish_target == 'npm-and-ghcr'
    permissions:
      contents: read
      id-token: write
    outputs:
      published-version: ${{ steps.publish.outputs.published-version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup_node_environment

      - name: Build packages
        run: pnpm packages:prepublish

      - name: Version packages with changesets (snapshot)
        run: |
          # Use changesets to create snapshot versions
          # The snapshot tag will be used as part of the version string
          pnpm changeset version --snapshot ${{ needs.validate-and-prepare.outputs.snapshot-tag }}

          echo "üì¶ Packages versioned with snapshot tag: ${{ needs.validate-and-prepare.outputs.snapshot-tag }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish release preview packages to NPM with changesets
        id: publish
        run: |
          # Publish with changesets using snapshot mode
          # --no-git-tag: Don't create git tags for preview releases
          # --snapshot: Publish as snapshot/preview release
          # --tag: Use our custom dist-tag
          pnpm changeset publish --no-git-tag --snapshot --tag ${{ needs.validate-and-prepare.outputs.dist-tag }}

          # Extract published version from package.json
          PUBLISHED_VERSION=$(node -p "require('./packages/ensnode-sdk/package.json').version")
          echo "published-version=${PUBLISHED_VERSION}" >> $GITHUB_OUTPUT

          echo "‚úÖ Published release preview packages to NPM with version: ${PUBLISHED_VERSION}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  build-and-publish-ghcr:
    name: Build & Publish Docker Images to GHCR
    runs-on: blacksmith-4vcpu-ubuntu-2204
    needs: [validate-and-prepare, build-and-publish-npm]
    if: inputs.publish_target == 'npm-and-ghcr'
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        app: [ensindexer, ensadmin, ensapi, ensrainbow]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Build & Publish Docker Image
        uses: ./.github/actions/build_docker_image
        with:
          image: ghcr.io/${{ github.repository }}/${{ matrix.app }}
          dockerfile: apps/${{ matrix.app }}/Dockerfile
          registry_user: ${{ github.actor }}
          registry_token: ${{ secrets.GITHUB_TOKEN }}
          tags: |
            type=raw,value=${{ needs.validate-and-prepare.outputs.docker-tag-base }}
            type=raw,value=${{ needs.validate-and-prepare.outputs.docker-tag-base }}-${{ needs.validate-and-prepare.outputs.commit-sha }}
            type=sha

  detect-pr-and-comment:
    name: Update PR Comment
    runs-on: blacksmith-4vcpu-ubuntu-2204
    needs: [validate-and-prepare, build-and-publish-npm, build-and-publish-ghcr]
    if: always() && needs.build-and-publish-npm.result == 'success'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Detect PR
        id: detect-pr
        run: |
          # Try to find PR for this branch
          PR_DATA=$(gh pr list --state=open --head="${{ github.ref_name }}" --base=main --json number,title,url --limit 1)

          if [[ "$PR_DATA" != "[]" && -n "$PR_DATA" ]]; then
            PR_NUMBER=$(echo "$PR_DATA" | jq -r '.[0].number')
            PR_TITLE=$(echo "$PR_DATA" | jq -r '.[0].title')
            PR_URL=$(echo "$PR_DATA" | jq -r '.[0].url')

            echo "pr-number=${PR_NUMBER}" >> $GITHUB_OUTPUT
            echo "pr-title=${PR_TITLE}" >> $GITHUB_OUTPUT
            echo "pr-url=${PR_URL}" >> $GITHUB_OUTPUT
            echo "has-pr=true" >> $GITHUB_OUTPUT

            echo "‚úÖ Found PR #${PR_NUMBER}: ${PR_TITLE}"
          else
            echo "has-pr=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No open PR found for branch ${{ github.ref_name }}"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate PR comment body
        id: comment
        if: steps.detect-pr.outputs.has-pr == 'true'
        run: |
          # Build timestamp for display
          BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # Start building comment
          COMMENT_BODY="## üöÄ Preview Packages - \`${{ github.ref_name }}\`

          "

          # NPM section - always present since both options include NPM
          if [[ "${{ needs.build-and-publish-npm.result }}" == "success" ]]; then
            COMMENT_BODY+="**NPM Packages:**
          \`\`\`bash
          # Install latest preview for this branch
          pnpm add @ensnode/datasources@${{ needs.validate-and-prepare.outputs.dist-tag }}
          pnpm add @ensnode/ensnode-react@${{ needs.validate-and-prepare.outputs.dist-tag }}
          pnpm add @ensnode/ensrainbow-sdk@${{ needs.validate-and-prepare.outputs.dist-tag }}
          pnpm add @ensnode/ensnode-schema@${{ needs.validate-and-prepare.outputs.dist-tag }}
          pnpm add @ensnode/ensnode-sdk@${{ needs.validate-and-prepare.outputs.dist-tag }}
          pnpm add @ensnode/ponder-subgraph@${{ needs.validate-and-prepare.outputs.dist-tag }}
          pnpm add @ensnode/ponder-metadata@${{ needs.validate-and-prepare.outputs.dist-tag }}
          pnpm add @ensnode/ens-referrals@${{ needs.validate-and-prepare.outputs.dist-tag }}

          # Or install specific version
          pnpm add @ensnode/ensnode-sdk@${{ needs.build-and-publish-npm.outputs.published-version }}
          \`\`\`

          "
          fi

          # GHCR section - only if ghcr was requested and succeeded
          if [[ "${{ inputs.publish_target }}" == "npm-and-ghcr" && "${{ needs.build-and-publish-ghcr.result }}" == "success" ]]; then
            COMMENT_BODY+="**Docker Images:**
          \`\`\`bash
          docker pull ghcr.io/namehash/ensnode/ensindexer:${{ needs.validate-and-prepare.outputs.docker-tag-base }}-${{ needs.validate-and-prepare.outputs.commit-sha }}
          docker pull ghcr.io/namehash/ensnode/ensadmin:${{ needs.validate-and-prepare.outputs.docker-tag-base }}-${{ needs.validate-and-prepare.outputs.commit-sha }}
          docker pull ghcr.io/namehash/ensnode/ensapi:${{ needs.validate-and-prepare.outputs.docker-tag-base }}-${{ needs.validate-and-prepare.outputs.commit-sha }}
          docker pull ghcr.io/namehash/ensnode/ensrainbow:${{ needs.validate-and-prepare.outputs.docker-tag-base }}-${{ needs.validate-and-prepare.outputs.commit-sha }}
          \`\`\`

          "
          elif [[ "${{ inputs.publish_target }}" == "npm-and-ghcr" && "${{ needs.build-and-publish-ghcr.result }}" != "success" ]]; then
            COMMENT_BODY+="**Docker Images:** ‚ùå Build failed - see [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          "
          fi

          # Publish target info
          PUBLISH_TARGET_DISPLAY=""
          if [[ "${{ inputs.publish_target }}" == "npm-only" ]]; then
            PUBLISH_TARGET_DISPLAY="üì¶ NPM packages only"
          elif [[ "${{ inputs.publish_target }}" == "npm-and-ghcr" ]]; then
            PUBLISH_TARGET_DISPLAY="üì¶ NPM packages + üê≥ Docker images"
          fi

          # Build info
          COMMENT_BODY+="**Build Info:**
          - üéØ Target: \`${PUBLISH_TARGET_DISPLAY}\`
          - üì¶ Version: \`${{ needs.build-and-publish-npm.outputs.published-version }}\`
          - üìù Commit: \`${{ needs.validate-and-prepare.outputs.commit-sha }}\`
          - üåø Branch: \`${{ github.ref_name }}\`
          - ‚è∞ Built: \`${BUILD_TIME}\`
          - üîó [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *ü§ñ This comment will be updated on subsequent publishing of release previews from the branch associated with this PR*

          > **Note:** Preview packages are managed by changesets. NPM dist-tags can be cleaned up manually using \`npm dist-tag rm @ensnode/ensnode-sdk ${{ needs.validate-and-prepare.outputs.dist-tag }}\`"

          # Save to file for proper multiline handling
          echo "$COMMENT_BODY" > comment_body.txt
          echo "comment-file=comment_body.txt" >> $GITHUB_OUTPUT

      - name: Find existing comment
        id: find-comment
        if: steps.detect-pr.outputs.has-pr == 'true'
        run: |
          # Look for existing comment from github-actions bot
          COMMENT_ID=$(gh pr view ${{ steps.detect-pr.outputs.pr-number }} --json comments --jq '.comments[] | select(.author.login == "github-actions" and (.body | contains("üöÄ Preview Packages"))) | .id' | head -1)

          if [[ -n "$COMMENT_ID" ]]; then
            echo "existing-comment-id=${COMMENT_ID}" >> $GITHUB_OUTPUT
            echo "‚úÖ Found existing comment ID: ${COMMENT_ID}"
          else
            echo "‚ÑπÔ∏è  No existing comment found, will create new one"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update or create PR comment
        if: steps.detect-pr.outputs.has-pr == 'true'
        run: |
          if [[ -n "${{ steps.find-comment.outputs.existing-comment-id }}" ]]; then
            # Update existing comment
            gh pr comment ${{ steps.detect-pr.outputs.pr-number }} --edit-last --body-file ${{ steps.comment.outputs.comment-file }}
            echo "‚úÖ Updated existing PR comment"
          else
            # Create new comment
            gh pr comment ${{ steps.detect-pr.outputs.pr-number }} --body-file ${{ steps.comment.outputs.comment-file }}
            echo "‚úÖ Created new PR comment"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log summary
        run: |
          echo "## üìã Preview Release Summary"
          echo "- Branch: ${{ github.ref_name }}"
          echo "- Publish target: ${{ inputs.publish_target }}"
          echo "- Published version: ${{ needs.build-and-publish-npm.outputs.published-version }}"
          echo "- NPM dist-tag: ${{ needs.validate-and-prepare.outputs.dist-tag }}"
          if [[ "${{ inputs.publish_target }}" == "npm-and-ghcr" ]]; then
            echo "- Docker tag: ${{ needs.validate-and-prepare.outputs.docker-tag-base }}-${{ needs.validate-and-prepare.outputs.commit-sha }}"
            echo "- GHCR publish: ${{ needs.build-and-publish-ghcr.result }}"
          fi
          echo "- NPM publish: ${{ needs.build-and-publish-npm.result }}"
          echo "- PR detected: ${{ steps.detect-pr.outputs.has-pr }}"
          if [[ "${{ steps.detect-pr.outputs.has-pr }}" == "true" ]]; then
            echo "- PR number: #${{ steps.detect-pr.outputs.pr-number }}"
          fi
