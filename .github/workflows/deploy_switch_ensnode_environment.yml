name: "Deploy: Switch ENSNode Environment"

on:
  workflow_dispatch:
    inputs:
      target:
        description: "New main environment (green or blue)"
        required: true
        type: choice
        options:
          - green
          - blue

jobs:
  switch-environment:
    # NOTE: this needs to run on GH runner because of some obscure skopeo permissions thing
    runs-on: ubuntu-latest
    name: Switch Environment to ${{ inputs.target }}
    env:
      TARGET_ENVIRONMENT: ${{ inputs.target }}
      REDIS_URL: ${{ secrets.TRAEFIK_REDIS_URL }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Calculate env variables
        run: |
          case "$TARGET_ENVIRONMENT" in
            "green")
              echo "SLACK_TITLE=:large_green_circle: GREEN Environment Activated" >> "$GITHUB_ENV"
              echo "RAILWAY_ENVIRONMENT_ID=${{ secrets.GREEN_RAILWAY_ENVIRONMENT_ID }}" >> $GITHUB_ENV
              ;;
            "blue")
              echo "SLACK_TITLE=:large_blue_circle: BLUE Environment Activated" >> "$GITHUB_ENV"
              echo "RAILWAY_ENVIRONMENT_ID=${{ secrets.BLUE_RAILWAY_ENVIRONMENT_ID }}" >> $GITHUB_ENV
              ;;
            *)
              echo "SLACK_TITLE=:large_red_circle: Unrecognized Environment Activated" >> "$GITHUB_ENV"
          esac

      - name: Switch Traefik Routing
        run: |
          sudo apt update
          sudo apt install -y redis-tools

          # ALPHA
          redis-cli -u $REDIS_URL SET traefik/http/routers/alpha-api-router/service "${TARGET_ENVIRONMENT}-alpha-api"
          redis-cli -u $REDIS_URL SET traefik/http/routers/alpha-indexer-router/service "${TARGET_ENVIRONMENT}-alpha-indexer"

          redis-cli -u $REDIS_URL SET traefik/http/routers/lb-header-alpha-api-router/service "${TARGET_ENVIRONMENT}-alpha-api"
          redis-cli -u $REDIS_URL SET traefik/http/routers/lb-header-alpha-indexer-router/service "${TARGET_ENVIRONMENT}-alpha-indexer"

          # MAINNET
          redis-cli -u $REDIS_URL SET traefik/http/routers/mainnet-api-router/service "${TARGET_ENVIRONMENT}-mainnet-api"
          redis-cli -u $REDIS_URL SET traefik/http/routers/mainnet-indexer-router/service "${TARGET_ENVIRONMENT}-mainnet-indexer"

          redis-cli -u $REDIS_URL SET traefik/http/routers/lb-header-mainnet-api-router/service "${TARGET_ENVIRONMENT}-alpha-api"
          redis-cli -u $REDIS_URL SET traefik/http/routers/lb-header-mainnet-indexer-router/service "${TARGET_ENVIRONMENT}-alpha-indexer"

          # ALPHA-SEPOLIA
          redis-cli -u $REDIS_URL SET traefik/http/routers/alpha-sepolia-api-router/service "${TARGET_ENVIRONMENT}-alpha-sepolia-api"
          redis-cli -u $REDIS_URL SET traefik/http/routers/alpha-sepolia-indexer-router/service "${TARGET_ENVIRONMENT}-alpha-sepolia-indexer"

          redis-cli -u $REDIS_URL SET traefik/http/routers/lb-header-alpha-sepolia-api-router/service "${TARGET_ENVIRONMENT}-alpha-sepolia-api"
          redis-cli -u $REDIS_URL SET traefik/http/routers/lb-header-alpha-sepolia-indexer-router/service "${TARGET_ENVIRONMENT}-alpha-sepolia-indexer"

          # V2-SEPOLIA
          redis-cli -u $REDIS_URL SET traefik/http/routers/v2-sepolia-api-router/service "${TARGET_ENVIRONMENT}-v2-sepolia-api"
          redis-cli -u $REDIS_URL SET traefik/http/routers/v2-sepolia-indexer-router/service "${TARGET_ENVIRONMENT}-v2-sepolia-indexer"

          redis-cli -u $REDIS_URL SET traefik/http/routers/lb-header-v2-sepolia-api-router/service "${TARGET_ENVIRONMENT}-v2-sepolia-api"
          redis-cli -u $REDIS_URL SET traefik/http/routers/lb-header-v2-sepolia-indexer-router/service "${TARGET_ENVIRONMENT}-v2-sepolia-indexer"

          # SEPOLIA
          redis-cli -u $REDIS_URL SET traefik/http/routers/sepolia-api-router/service "${TARGET_ENVIRONMENT}-sepolia-api"
          redis-cli -u $REDIS_URL SET traefik/http/routers/sepolia-indexer-router/service "${TARGET_ENVIRONMENT}-sepolia-indexer"

          redis-cli -u $REDIS_URL SET traefik/http/routers/lb-header-sepolia-api-router/service "${TARGET_ENVIRONMENT}-sepolia-api"
          redis-cli -u $REDIS_URL SET traefik/http/routers/lb-header-sepolia-indexer-router/service "${TARGET_ENVIRONMENT}-sepolia-indexer"

          # ENSRAINBOW
          redis-cli -u $REDIS_URL SET traefik/http/routers/ensrainbow-api-router/service "${TARGET_ENVIRONMENT}-ensrainbow-api"

          # ENSRAINBOW SEARCHLIGHT
          redis-cli -u $REDIS_URL SET traefik/http/routers/ensrainbow-searchlight-api-router/service "${TARGET_ENVIRONMENT}-ensrainbow-searchlight-api"

      - name: Promote ENSAdmin Vercel Deployment
        run: |
          chmod +x ./.github/scripts/promote_ensadmin.sh
          ./.github/scripts/promote_ensadmin.sh

      - name: Trigger Mintlify Docs Rebuild
        id: mintlify_rebuild
        # Non-blocking: failures are reported to Slack and can be manually retriggered
        continue-on-error: true
        env:
          MINTLIFY_API_TOKEN: ${{ secrets.MINTLIFY_API_TOKEN }}
          MINTLIFY_PROJECT_ID: ${{ vars.MINTLIFY_PROJECT_ID }}
        run: |
          # Trigger the rebuild and capture the statusId
          HTTP_RESPONSE=$(curl --silent --write-out "\n%{http_code}" \
            --connect-timeout 10 \
            --max-time 30 \
            --retry 2 \
            --retry-delay 5 \
            --request POST \
            --url "https://api.mintlify.com/v1/project/update/${MINTLIFY_PROJECT_ID}" \
            --header "Authorization: Bearer ${MINTLIFY_API_TOKEN}")

          HTTP_BODY=$(echo "$HTTP_RESPONSE" | sed '$d')
          HTTP_CODE=$(echo "$HTTP_RESPONSE" | tail -n1)

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "Mintlify API returned HTTP $HTTP_CODE"
            echo "Response body: $HTTP_BODY"
            exit 1
          fi

          echo "Mintlify rebuild triggered successfully (HTTP $HTTP_CODE)"

          # Extract statusId from response
          STATUS_ID=$(echo "$HTTP_BODY" | jq -r '.statusId // empty')
          if [ -z "$STATUS_ID" ]; then
            echo "Failed to extract statusId from response"
            echo "Response body: $HTTP_BODY"
            exit 1
          fi

          echo "Status ID: $STATUS_ID"

          # Poll for completion (max 5 minutes, checking every 10 seconds)
          MAX_ATTEMPTS=30
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Checking status (attempt $ATTEMPT/$MAX_ATTEMPTS)..."

            STATUS_RESPONSE=$(curl --silent --write-out "\n%{http_code}" \
              --connect-timeout 10 \
              --max-time 30 \
              --request GET \
              --url "https://api.mintlify.com/v1/project/update-status/${STATUS_ID}" \
              --header "Authorization: Bearer ${MINTLIFY_API_TOKEN}")

            STATUS_BODY=$(echo "$STATUS_RESPONSE" | sed '$d')
            STATUS_CODE=$(echo "$STATUS_RESPONSE" | tail -n1)

            if [ "$STATUS_CODE" -lt 200 ] || [ "$STATUS_CODE" -ge 300 ]; then
              echo "Status check failed with HTTP $STATUS_CODE"
              echo "Response: $STATUS_BODY"
              sleep 10
              continue
            fi

            STATUS=$(echo "$STATUS_BODY" | jq -r '.status // empty')
            echo "Current status: $STATUS"

            case "$STATUS" in
              "success")
                echo "Mintlify docs rebuild completed successfully"
                exit 0
                ;;
              "failure")
                echo "Mintlify docs rebuild failed"
                exit 1
                ;;
              "queued"|"in_progress")
                sleep 10
                ;;
              *)
                echo "Unknown status: $STATUS"
                sleep 10
                ;;
            esac
          done

          echo "Timeout waiting for Mintlify rebuild to complete"
          exit 1

      - name: Notify Mintlify Rebuild Failure
        if: steps.mintlify_rebuild.outcome == 'failure'
        uses: ./.github/actions/send_slack_notification
        with:
          slack_webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          slack_title: "Mintlify Docs Rebuild Failed"
          slack_message: "Mintlify docs rebuild failed during environment switch to ${{ inputs.target }}. Check the workflow logs for details."

      - name: Notify Mintlify Rebuild Success
        if: steps.mintlify_rebuild.outcome == 'success'
        uses: ./.github/actions/send_slack_notification
        with:
          slack_webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          slack_title: "Mintlify Docs Rebuilt"
          slack_message: "Mintlify docs successfully rebuilt for environment switch to ${{ inputs.target }}"

      - name: Send Slack Notification
        uses: ./.github/actions/send_slack_notification
        with:
          slack_webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          slack_title: ${{ env.SLACK_TITLE }}
          slack_message: "âœ… Switch ENSNode environment completed"
